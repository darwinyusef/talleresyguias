// Pipeline completo para aplicaciÃ³n Node.js
// Incluye: build, test, lint, security scan, docker build y deploy

pipeline {
    agent any
    
    environment {
        // ConfiguraciÃ³n de la aplicaciÃ³n
        APP_NAME = 'nodejs-app'
        NODE_VERSION = '18'
        
        // Docker
        DOCKER_IMAGE = "usuario/${APP_NAME}"
        DOCKER_TAG = "${BUILD_NUMBER}"
        
        // Entorno
        NODE_ENV = 'production'
    }
    
    parameters {
        choice(
            name: 'ENVIRONMENT',
            choices: ['dev', 'staging', 'production'],
            description: 'Entorno de deployment'
        )
        booleanParam(
            name: 'RUN_TESTS',
            defaultValue: true,
            description: 'Â¿Ejecutar tests?'
        )
        booleanParam(
            name: 'DEPLOY',
            defaultValue: false,
            description: 'Â¿Desplegar despuÃ©s del build?'
        )
    }
    
    stages {
        stage('Checkout') {
            steps {
                echo 'ðŸ“¥ Clonando repositorio...'
                // git branch: 'main', url: 'https://github.com/usuario/nodejs-app.git'
                
                // Para este ejemplo, creamos una app Node.js simple
                sh '''
                    # Crear package.json
                    cat > package.json << 'EOF'
{
  "name": "nodejs-app",
  "version": "1.0.0",
  "description": "AplicaciÃ³n Node.js de ejemplo",
  "main": "index.js",
  "scripts": {
    "start": "node index.js",
    "dev": "nodemon index.js",
    "test": "jest --coverage",
    "lint": "eslint .",
    "build": "echo 'Building app...'",
    "security-check": "npm audit"
  },
  "dependencies": {
    "express": "^4.18.2"
  },
  "devDependencies": {
    "jest": "^29.5.0",
    "eslint": "^8.40.0",
    "nodemon": "^2.0.22"
  }
}
EOF

                    # Crear aplicaciÃ³n Express
                    cat > index.js << 'EOF'
const express = require('express');
const app = express();
const PORT = process.env.PORT || 3000;

app.get('/', (req, res) => {
  res.json({
    message: 'Hello from Node.js!',
    version: '1.0.0',
    environment: process.env.NODE_ENV || 'development'
  });
});

app.get('/health', (req, res) => {
  res.json({ status: 'healthy' });
});

if (require.main === module) {
  app.listen(PORT, () => {
    console.log(`Server running on port ${PORT}`);
  });
}

module.exports = app;
EOF

                    # Crear tests
                    cat > app.test.js << 'EOF'
const request = require('supertest');
const app = require('./index');

describe('API Tests', () => {
  test('GET / should return welcome message', async () => {
    const response = await request(app).get('/');
    expect(response.status).toBe(200);
    expect(response.body.message).toBe('Hello from Node.js!');
  });

  test('GET /health should return healthy status', async () => {
    const response = await request(app).get('/health');
    expect(response.status).toBe(200);
    expect(response.body.status).toBe('healthy');
  });
});
EOF

                    # Crear Dockerfile
                    cat > Dockerfile << 'EOF'
# Stage 1: Build
FROM node:18-alpine AS builder
WORKDIR /app
COPY package*.json ./
RUN npm ci --only=production

# Stage 2: Production
FROM node:18-alpine
WORKDIR /app
COPY --from=builder /app/node_modules ./node_modules
COPY . .
EXPOSE 3000
USER node
CMD ["npm", "start"]
EOF

                    # Crear .dockerignore
                    cat > .dockerignore << 'EOF'
node_modules
npm-debug.log
.git
.gitignore
README.md
.env
coverage
.DS_Store
EOF
                '''
            }
        }
        
        stage('Install Dependencies') {
            agent {
                docker {
                    image "node:${NODE_VERSION}-alpine"
                    args '-u root'
                }
            }
            steps {
                echo 'ðŸ“¦ Instalando dependencias...'
                sh '''
                    npm ci
                    npm list --depth=0
                '''
            }
        }
        
        stage('Lint') {
            agent {
                docker {
                    image "node:${NODE_VERSION}-alpine"
                    args '-u root'
                }
            }
            steps {
                echo 'ðŸ” Ejecutando linter...'
                sh '''
                    # Crear configuraciÃ³n de ESLint
                    cat > .eslintrc.json << 'EOF'
{
  "env": {
    "node": true,
    "es2021": true
  },
  "extends": "eslint:recommended",
  "parserOptions": {
    "ecmaVersion": 12
  },
  "rules": {}
}
EOF
                    npm run lint || true
                '''
            }
        }
        
        stage('Security Audit') {
            agent {
                docker {
                    image "node:${NODE_VERSION}-alpine"
                }
            }
            steps {
                echo 'ðŸ”’ Verificando vulnerabilidades de seguridad...'
                sh '''
                    npm audit --audit-level=moderate || true
                '''
            }
        }
        
        stage('Unit Tests') {
            when {
                expression { params.RUN_TESTS == true }
            }
            agent {
                docker {
                    image "node:${NODE_VERSION}-alpine"
                    args '-u root'
                }
            }
            steps {
                echo 'ðŸ§ª Ejecutando tests unitarios...'
                sh '''
                    # Instalar supertest para tests
                    npm install --save-dev supertest
                    
                    # Ejecutar tests
                    npm test || true
                '''
            }
            post {
                always {
                    // Publicar resultados de tests
                    junit '**/test-results/*.xml' allowEmptyResults: true
                    
                    // Publicar cobertura
                    publishHTML([
                        reportDir: 'coverage',
                        reportFiles: 'index.html',
                        reportName: 'Coverage Report'
                    ]) allowMissing: true
                }
            }
        }
        
        stage('Build') {
            steps {
                echo 'ðŸ”¨ Construyendo aplicaciÃ³n...'
                sh 'npm run build'
            }
        }
        
        stage('Build Docker Image') {
            steps {
                echo 'ðŸ³ Construyendo imagen Docker...'
                script {
                    dockerImage = docker.build("${DOCKER_IMAGE}:${DOCKER_TAG}")
                    sh "docker tag ${DOCKER_IMAGE}:${DOCKER_TAG} ${DOCKER_IMAGE}:latest"
                }
            }
        }
        
        stage('Test Docker Image') {
            steps {
                echo 'ðŸ§ª Probando imagen Docker...'
                sh """
                    # Ejecutar contenedor de prueba
                    docker run -d --name test-${BUILD_NUMBER} -p 3001:3000 ${DOCKER_IMAGE}:${DOCKER_TAG}
                    
                    # Esperar a que inicie
                    sleep 5
                    
                    # Probar endpoint de health
                    curl -f http://localhost:3001/health || exit 1
                    
                    # Limpiar
                    docker stop test-${BUILD_NUMBER}
                    docker rm test-${BUILD_NUMBER}
                """
            }
        }
        
        stage('Push to Registry') {
            when {
                expression { params.ENVIRONMENT == 'production' }
            }
            steps {
                echo 'ðŸ“¤ Publicando imagen a Docker Hub...'
                script {
                    docker.withRegistry('https://registry.hub.docker.com', 'dockerhub-credentials') {
                        dockerImage.push("${DOCKER_TAG}")
                        dockerImage.push('latest')
                    }
                }
            }
        }
        
        stage('Deploy') {
            when {
                expression { params.DEPLOY == true }
            }
            steps {
                echo "ðŸš€ Desplegando a ${params.ENVIRONMENT}..."
                script {
                    def port = 3000
                    if (params.ENVIRONMENT == 'staging') {
                        port = 3001
                    } else if (params.ENVIRONMENT == 'dev') {
                        port = 3002
                    }
                    
                    sh """
                        # Detener contenedor anterior
                        docker stop ${APP_NAME}-${params.ENVIRONMENT} || true
                        docker rm ${APP_NAME}-${params.ENVIRONMENT} || true
                        
                        # Ejecutar nuevo contenedor
                        docker run -d \
                            --name ${APP_NAME}-${params.ENVIRONMENT} \
                            -p ${port}:3000 \
                            -e NODE_ENV=${params.ENVIRONMENT} \
                            --restart unless-stopped \
                            ${DOCKER_IMAGE}:${DOCKER_TAG}
                        
                        # Verificar deployment
                        sleep 3
                        curl -f http://localhost:${port}/health || exit 1
                    """
                }
            }
        }
    }
    
    post {
        always {
            echo 'ðŸ§¹ Limpieza...'
            sh '''
                docker image prune -f
                docker container prune -f
            '''
        }
        success {
            echo 'âœ… Pipeline completado exitosamente!'
            echo "Imagen: ${DOCKER_IMAGE}:${DOCKER_TAG}"
            echo "Entorno: ${params.ENVIRONMENT}"
        }
        failure {
            echo 'âŒ Pipeline fallÃ³!'
        }
    }
}
