// Pipeline con ejecuciÃ³n paralela de stages
// Demuestra cÃ³mo ejecutar mÃºltiples tareas simultÃ¡neamente

pipeline {
    agent any
    
    environment {
        PROJECT_NAME = 'multi-service-app'
    }
    
    stages {
        stage('Checkout') {
            steps {
                echo 'ðŸ“¥ Clonando repositorio...'
                sh 'echo "Simulando git clone..."'
            }
        }
        
        stage('Parallel Build') {
            parallel {
                stage('Build Frontend') {
                    agent {
                        docker {
                            image 'node:18-alpine'
                            args '-u root'
                        }
                    }
                    steps {
                        echo 'ðŸŽ¨ Building Frontend (React)...'
                        sh '''
                            echo "Installing frontend dependencies..."
                            sleep 3
                            echo "Building React app..."
                            sleep 2
                            echo "Frontend build complete!"
                        '''
                    }
                }
                
                stage('Build Backend') {
                    agent {
                        docker {
                            image 'node:18-alpine'
                            args '-u root'
                        }
                    }
                    steps {
                        echo 'âš™ï¸ Building Backend (Node.js)...'
                        sh '''
                            echo "Installing backend dependencies..."
                            sleep 3
                            echo "Building Express API..."
                            sleep 2
                            echo "Backend build complete!"
                        '''
                    }
                }
                
                stage('Build Mobile') {
                    agent {
                        docker {
                            image 'node:18-alpine'
                            args '-u root'
                        }
                    }
                    steps {
                        echo 'ðŸ“± Building Mobile (React Native)...'
                        sh '''
                            echo "Installing mobile dependencies..."
                            sleep 3
                            echo "Building React Native app..."
                            sleep 2
                            echo "Mobile build complete!"
                        '''
                    }
                }
            }
        }
        
        stage('Parallel Tests') {
            parallel {
                stage('Unit Tests') {
                    steps {
                        echo 'ðŸ§ª Running Unit Tests...'
                        sh '''
                            echo "Running Jest tests..."
                            sleep 2
                            echo "âœ… 50 tests passed"
                        '''
                    }
                }
                
                stage('Integration Tests') {
                    steps {
                        echo 'ðŸ”— Running Integration Tests...'
                        sh '''
                            echo "Starting test database..."
                            sleep 1
                            echo "Running integration tests..."
                            sleep 3
                            echo "âœ… 20 integration tests passed"
                        '''
                    }
                }
                
                stage('E2E Tests') {
                    steps {
                        echo 'ðŸŒ Running E2E Tests...'
                        sh '''
                            echo "Starting Selenium..."
                            sleep 1
                            echo "Running E2E tests..."
                            sleep 4
                            echo "âœ… 10 E2E tests passed"
                        '''
                    }
                }
                
                stage('Security Scan') {
                    steps {
                        echo 'ðŸ”’ Running Security Scan...'
                        sh '''
                            echo "Scanning dependencies..."
                            sleep 2
                            echo "Running OWASP check..."
                            sleep 2
                            echo "âœ… No vulnerabilities found"
                        '''
                    }
                }
            }
        }
        
        stage('Parallel Docker Builds') {
            parallel {
                stage('Build Frontend Image') {
                    steps {
                        echo 'ðŸ³ Building Frontend Docker Image...'
                        sh '''
                            cat > Dockerfile.frontend << 'EOF'
FROM node:18-alpine
WORKDIR /app
COPY frontend/package*.json ./
RUN npm ci --only=production
COPY frontend/ .
RUN npm run build
EXPOSE 3000
CMD ["npm", "start"]
EOF
                            echo "Building frontend image..."
                            sleep 2
                            # docker build -f Dockerfile.frontend -t frontend:${BUILD_NUMBER} .
                        '''
                    }
                }
                
                stage('Build Backend Image') {
                    steps {
                        echo 'ðŸ³ Building Backend Docker Image...'
                        sh '''
                            cat > Dockerfile.backend << 'EOF'
FROM node:18-alpine
WORKDIR /app
COPY backend/package*.json ./
RUN npm ci --only=production
COPY backend/ .
EXPOSE 4000
CMD ["npm", "start"]
EOF
                            echo "Building backend image..."
                            sleep 2
                            # docker build -f Dockerfile.backend -t backend:${BUILD_NUMBER} .
                        '''
                    }
                }
                
                stage('Build Worker Image') {
                    steps {
                        echo 'ðŸ³ Building Worker Docker Image...'
                        sh '''
                            cat > Dockerfile.worker << 'EOF'
FROM python:3.11-slim
WORKDIR /app
COPY worker/requirements.txt .
RUN pip install -r requirements.txt
COPY worker/ .
CMD ["python", "worker.py"]
EOF
                            echo "Building worker image..."
                            sleep 2
                            # docker build -f Dockerfile.worker -t worker:${BUILD_NUMBER} .
                        '''
                    }
                }
            }
        }
        
        stage('Parallel Deployments') {
            parallel {
                stage('Deploy to Dev') {
                    steps {
                        echo 'ðŸš€ Deploying to Development...'
                        sh '''
                            echo "Deploying to dev environment..."
                            sleep 2
                            echo "âœ… Dev deployment complete"
                        '''
                    }
                }
                
                stage('Deploy to Staging') {
                    steps {
                        echo 'ðŸš€ Deploying to Staging...'
                        sh '''
                            echo "Deploying to staging environment..."
                            sleep 2
                            echo "âœ… Staging deployment complete"
                        '''
                    }
                }
            }
        }
        
        stage('Smoke Tests') {
            parallel {
                stage('Test Dev') {
                    steps {
                        echo 'ðŸ’¨ Running smoke tests on Dev...'
                        sh '''
                            echo "Testing dev endpoints..."
                            sleep 1
                            echo "âœ… Dev is healthy"
                        '''
                    }
                }
                
                stage('Test Staging') {
                    steps {
                        echo 'ðŸ’¨ Running smoke tests on Staging...'
                        sh '''
                            echo "Testing staging endpoints..."
                            sleep 1
                            echo "âœ… Staging is healthy"
                        '''
                    }
                }
            }
        }
    }
    
    post {
        success {
            echo 'âœ… All parallel stages completed successfully!'
            echo '''
            ðŸ“Š Summary:
            - Frontend: Built âœ“
            - Backend: Built âœ“
            - Mobile: Built âœ“
            - All Tests: Passed âœ“
            - Docker Images: Built âœ“
            - Deployments: Complete âœ“
            '''
        }
        failure {
            echo 'âŒ One or more parallel stages failed!'
        }
    }
}
